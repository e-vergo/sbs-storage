# Retrospective: Fix Stale .olean Detection (#281)

## What Was Done

Fixed a persistent issue where stale `.olean` files caused served content to not reflect latest code changes. Three-layer solution:

**Layer 1 — Inverted skip logic:** Build pipeline now always runs Lake by default. The old `--force-lake` flag (which forced builds) is replaced with `--skip-lake` (which opts into skipping). This eliminates the entire class of "built but stale" bugs because Lake's own trace system handles staleness detection comprehensively.

**Layer 2 — `sbs clean` CLI command:** New command for targeted artifact removal. Supports `--project NAME` (cleans project + toolchain deps), `--all --force` (cleans everything), `--check` (dry-run with sizes), and `--full` (also removes `.lake/packages/`). Also cleans `lakefile.olean` which `lake clean` misses.

**Layer 3 — Fixed serve tool:** `sbs_serve_project` MCP tool was hardcoded to serve from nonexistent `_site/` directory. Fixed to `.lake/build/runway/`. Added pre-serve freshness warning when artifacts are >24h old. Fixed `python` → `python3` for macOS.

## Files Changed

| File | Change |
|------|--------|
| `dev/scripts/sbs/build/config.py` | `force_lake` → `skip_lake` field |
| `dev/scripts/sbs/build/orchestrator.py` | 8 modification sites inverting skip logic |
| `dev/scripts/sbs/commands/clean.py` | NEW: sbs clean command |
| `dev/scripts/sbs/build/phases.py` | Enhanced `clean_build_artifacts()` |
| `dev/scripts/sbs/cli.py` | Clean command registration |
| `forks/sbs-lsp-mcp/src/sbs_lsp_mcp/sbs_tools.py` | Serve path fix + freshness warning |
| `forks/sbs-lsp-mcp/src/sbs_lsp_mcp/sbs_models.py` | `warning` field on ServeResult |
| `dev/scripts/sbs/tests/pytest/test_clean.py` | NEW: 10 tests |
| `dev/scripts/sbs/tests/pytest/test_build_staleness.py` | NEW: 9 tests |
| `CLAUDE.md` | Updated docs |

## Results

- 19 new tests, all passing
- 821 evergreen tests passing (1 pre-existing failure unrelated)
- `sbs clean --check --project SBSTest` reports 2.8 GB cleanable
- Zero stale `_site` references remain
- `force_lake` only in deprecated handler

## Process Notes

- Task executed cleanly through full /task lifecycle: start → plan → execute → finalize
- Used EnterPlanMode for proper planning before execution
- 3 waves: Wave 1 (3 parallel agents), Wave 2 (2 parallel agents), Wave 3 (sequential validation)
- IO captured: Plan agent should receive raw research output, not orchestrator summaries
