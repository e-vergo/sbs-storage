# Crush 2: Performance + Infoview — Retrospective

## Scope
Implemented all 5 issues from Crush 2 of the SBS Rewrite Epic (#224):
- **#250** SubVerso critical path optimization
- **#251** Lazy/incremental SubVerso highlighting
- **#252** Fork Lean infoview: setup and minimal SBS panel
- **#253** Wire SBS blueprint data to infoview via Lean RPC
- **#254** Heuristic statement-signature cross-referencing

## Execution Structure
- **Wave 1** (parallel): #250, #252, #254 — independent repos, no file overlap
- **Wave 2** (parallel): #251 (depends on #250), #253 (depends on #252)
- Branch: `crush-1-foundation` (no merge to main per user direction)

## Key Deliverables

### Track 2-B: SubVerso Performance (#250 + #251)
- `ModuleHighlightCache` with cross-declaration persistence (terms, ppTerms, signatureCache, highlightResults, typeHashes)
- `buildStandaloneSuffixIndex` for O(E) amortization across declarations
- `SBS_PROFILE` instrumentation for per-phase timing
- `HighlightResult` enum (cached/fresh/skipped) with type-hash invalidation
- `lazyHighlightIncludingUnparsed` for cache-first highlighting
- `IncrementalCaptureState` tracking declsProcessed/fromCache/reHighlighted
- `resetModuleCaches` for module-boundary cleanup

### Track 3: Infoview (#252 + #253)
- Forked vscode-lean4 to e-vergo/vscode-lean4 as submodule
- `BlueprintPanel.tsx` React component with collapsible Details section
- `Architect/RPC.lean` with `@[server_rpc_method]` endpoint `Architect.blueprintInfo`
- Real RPC wiring: cursor-driven blueprint data display with debouncing

### Track 4-B: Cross-Referencing (#254)
- `CrossRef.lean` (381 lines) with `SignatureComponents` and `StatementComponents` extraction
- 3 heuristic rules: math structure match, quantifier balance, name relevance
- Wired into `@[blueprint]` attribute with `skipCrossRef` option
- Zero false positives on SBS-Test and GCR

## Files Modified/Created
| Repo | File | Action |
|------|------|--------|
| SubVerso | Code.lean | Modified (+150 lines) |
| Dress | InfoTree.lean | Modified (+80 lines) |
| Dress | Capture/State.lean | Import added |
| LeanArchitect | CrossRef.lean | Created (381 lines) |
| LeanArchitect | RPC.lean | Created (104 lines) |
| LeanArchitect | Attribute.lean | Modified |
| LeanArchitect | Architect.lean | Modified (imports) |
| vscode-lean4 | blueprintPanel.tsx | Created (215 lines) |
| vscode-lean4 | main.tsx | Modified |
| vscode-lean4 | index.css | Modified |
| SBS-Test | lakefile.toml | Modified |

## Test Results
- Evergreen tests: 600 passed, 86 failed (all failures pre-existing CSS/authoring tests)
- SubVerso diagnostics: 0 errors
- LeanArchitect diagnostics: 0 errors
- SBS-Test build: clean

## Process Notes
- Background agent spawning caused dead time; switched to block-wait per user direction
- Two improvement observations captured for future workflow refinement
