# Auto-tagging rules for archive entries (colon-delimited agent-state taxonomy)
# Rules are evaluated in order; all matching rules apply their tags.
#
# scope field on each rule:
#   entry   -- rule evaluates entry-specific context fields
#   session -- rule evaluates session-constant context fields
#   both    -- rule evaluates fields that may come from either context

version: "2.0"

rules:
  # ==========================================================================
  # phase: Current workflow phase (from substate)
  # ==========================================================================

  - name: phase-alignment
    scope: entry
    condition:
      field: substate
      equals: "alignment"
    tags: ["phase:alignment"]

  - name: phase-planning
    scope: entry
    condition:
      field: substate
      equals: "planning"
    tags: ["phase:planning"]

  - name: phase-execution
    scope: entry
    condition:
      field: substate
      equals: "execution"
    tags: ["phase:execution"]

  - name: phase-finalization
    scope: entry
    condition:
      field: substate
      equals: "finalization"
    tags: ["phase:finalization"]

  - name: phase-readme-wave
    scope: entry
    condition:
      field: substate
      equals: "readme-wave"
    tags: ["phase:readme-wave"]

  - name: phase-oracle-regen
    scope: entry
    condition:
      field: substate
      equals: "oracle-regen"
    tags: ["phase:oracle-regen"]

  - name: phase-porcelain
    scope: entry
    condition:
      field: substate
      equals: "porcelain"
    tags: ["phase:porcelain"]

  - name: phase-archive-upload
    scope: entry
    condition:
      field: substate
      equals: "archive-upload"
    tags: ["phase:archive-upload"]

  - name: phase-idle
    scope: entry
    condition:
      field: skill
      is_empty: true
    tags: ["phase:idle"]

  # ==========================================================================
  # transition: State machine transition events
  # ==========================================================================

  - name: transition-phase-start
    scope: entry
    condition:
      field: state_transition
      equals: "phase_start"
    tags: ["transition:phase-start"]

  - name: transition-phase-end
    scope: entry
    condition:
      field: state_transition
      equals: "phase_end"
    tags: ["transition:phase-end"]

  - name: transition-handoff
    scope: entry
    condition:
      field: state_transition
      equals: "handoff"
    tags: ["transition:handoff"]

  - name: transition-phase-fail
    scope: entry
    condition:
      field: state_transition
      equals: "phase_fail"
    tags: ["transition:phase-fail"]

  - name: transition-epoch-close
    scope: entry
    condition:
      field: has_epoch_summary
      equals: true
    tags: ["transition:epoch-close"]

  # ==========================================================================
  # skill: Active skill type
  # ==========================================================================

  - name: skill-task
    scope: entry
    condition:
      field: skill
      equals: "task"
    tags: ["skill:task"]

  - name: skill-self-improve
    scope: entry
    condition:
      field: skill
      equals: "self-improve"
    tags: ["skill:self-improve"]

  - name: skill-update-and-archive
    scope: entry
    condition:
      field: skill
      equals: "update-and-archive"
    tags: ["skill:update-and-archive"]

  - name: skill-log
    scope: entry
    condition:
      field: skill
      equals: "log"
    tags: ["skill:log"]

  - name: skill-none
    scope: entry
    condition:
      field: skill
      is_empty: true
    tags: ["skill:none"]

  # ==========================================================================
  # trigger: What initiated this archive entry
  # ==========================================================================

  - name: trigger-build
    scope: entry
    condition:
      field: trigger
      equals: "build"
    tags: ["trigger:build"]

  - name: trigger-skill
    scope: entry
    condition:
      field: trigger
      equals: "skill"
    tags: ["trigger:skill"]

  - name: trigger-manual
    scope: entry
    condition:
      field: trigger
      equals: "manual"
    tags: ["trigger:manual"]

  - name: trigger-improvement
    scope: entry
    condition:
      field: trigger
      equals: "improvement"
    tags: ["trigger:improvement"]

  # ==========================================================================
  # scope: Change breadth (file types, repo count)
  # ==========================================================================

  - name: scope-cross-repo
    scope: entry
    condition:
      field: repos_changed_count
      greater_than: 2
    tags: ["scope:cross-repo"]

  - name: scope-multi-repo
    scope: entry
    condition:
      field: repos_changed_count
      equals: 2
    tags: ["scope:multi-repo"]

  - name: scope-css-js
    scope: entry
    condition:
      field: files_modified
      matches_any: ["*.css", "*.js"]
    tags: ["scope:css-js"]

  - name: scope-lean
    scope: entry
    condition:
      field: files_modified
      matches_any: ["*.lean"]
    tags: ["scope:lean"]

  - name: scope-python
    scope: entry
    condition:
      field: files_modified
      matches_any: ["*.py"]
    tags: ["scope:python"]

  - name: scope-config
    scope: entry
    condition:
      field: files_modified
      matches_any: ["*.yaml", "*.json", "*.toml"]
    tags: ["scope:config"]

  - name: scope-wide
    scope: entry
    condition:
      field: files_modified_count
      greater_than: 50
    tags: ["scope:wide"]

  - name: scope-narrow
    scope: entry
    condition:
      field: files_modified_count
      less_than: 5
    tags: ["scope:narrow"]

  # ==========================================================================
  # repo: Which repositories were touched
  # ==========================================================================

  - name: repo-dress
    scope: entry
    condition:
      field: files_modified
      matches_any: ["*/Dress/*"]
    tags: ["repo:dress"]

  - name: repo-runway
    scope: entry
    condition:
      field: files_modified
      matches_any: ["*/Runway/*"]
    tags: ["repo:runway"]

  - name: repo-sbs-test
    scope: entry
    condition:
      field: files_modified
      matches_any: ["*/SBS-Test/*"]
    tags: ["repo:sbs-test"]

  - name: repo-gcr
    scope: entry
    condition:
      field: files_modified
      matches_any: ["*/General_Crystallographic_Restriction/*"]
    tags: ["repo:gcr"]

  - name: repo-pnt
    scope: entry
    condition:
      field: files_modified
      matches_any: ["*/PrimeNumberTheoremAnd/*"]
    tags: ["repo:pnt"]

  - name: repo-verso
    scope: entry
    condition:
      field: files_modified
      matches_any: ["*/verso/*"]
    tags: ["repo:verso"]

  - name: repo-subverso
    scope: entry
    condition:
      field: files_modified
      matches_any: ["*/subverso/*"]
    tags: ["repo:subverso"]

  - name: repo-lean-architect
    scope: entry
    condition:
      field: files_modified
      matches_any: ["*/LeanArchitect/*"]
    tags: ["repo:lean-architect"]

  - name: repo-sbs-lsp-mcp
    scope: entry
    condition:
      field: files_modified
      matches_any: ["*/sbs-lsp-mcp/*"]
    tags: ["repo:sbs-lsp-mcp"]

  - name: repo-dress-blueprint-action
    scope: entry
    condition:
      field: files_modified
      matches_any: ["*/dress-blueprint-action/*"]
    tags: ["repo:dress-blueprint-action"]

  # ==========================================================================
  # linkage: Connections to external artifacts (issues, PRs, plans)
  # ==========================================================================

  - name: linkage-has-issue
    scope: entry
    condition:
      field: issue_refs
      is_empty: false
    tags: ["linkage:has-issue"]

  - name: linkage-has-pr
    scope: entry
    condition:
      field: pr_refs
      is_empty: false
    tags: ["linkage:has-pr"]

  - name: linkage-has-plan
    scope: session
    condition:
      field: plan_count
      greater_than: 0
    tags: ["linkage:has-plan"]

  # ==========================================================================
  # outcome: Build and gate results
  # ==========================================================================

  - name: outcome-build-success
    scope: entry
    condition:
      field: build_success
      equals: true
    tags: ["outcome:build-success"]

  - name: outcome-build-fail
    scope: entry
    condition:
      field: build_success
      equals: false
    tags: ["outcome:build-fail"]

  - name: outcome-gate-pass
    scope: entry
    condition:
      field: gate_passed
      equals: true
    tags: ["outcome:gate-pass"]

  - name: outcome-gate-fail
    scope: entry
    condition:
      field: gate_passed
      equals: false
    tags: ["outcome:gate-fail"]

  # ==========================================================================
  # quality: Quality score changes (entry-level)
  # ==========================================================================

  - name: quality-has-scores
    scope: entry
    condition:
      field: quality_overall
      greater_than: 0
    tags: ["quality:has-scores"]

  # ==========================================================================
  # content: Entry content indicators
  # ==========================================================================

  - name: content-has-screenshots
    scope: entry
    condition:
      field: screenshot_count
      greater_than: 0
    tags: ["content:has-screenshots"]

  - name: content-has-notes
    scope: entry
    condition:
      field: has_notes
      equals: true
    tags: ["content:has-notes"]

  - name: content-multi-repo
    scope: entry
    condition:
      field: repo_count
      greater_than: 1
    tags: ["content:multi-repo-commits"]

# =============================================================================
# Python hooks for complex analysis
# Hooks receive (entry: ArchiveEntry, sessions: list[SessionData]) and return list[str]
# =============================================================================
hooks:
  - name: session-profiler
    module: session_profiler
    function: profile_session
    scope: session

  - name: signal-detector
    module: signal_detector
    function: detect_signals
    scope: both

  - name: outcome-tagger
    module: outcome_tagger
    function: tag_outcomes
    scope: both

  - name: oracle-first-compliance
    module: oracle_first
    function: check_oracle_first
    scope: session
