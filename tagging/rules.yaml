# Auto-tagging rules for archive entries (colon-delimited agent-state taxonomy)
# Rules are evaluated in order; all matching rules apply their tags.

version: "2.0"

rules:
  # ==========================================================================
  # phase: Current workflow phase (from substate)
  # ==========================================================================

  - name: phase-alignment
    condition:
      field: substate
      equals: "alignment"
    tags: ["phase:alignment"]

  - name: phase-planning
    condition:
      field: substate
      equals: "planning"
    tags: ["phase:planning"]

  - name: phase-execution
    condition:
      field: substate
      equals: "execution"
    tags: ["phase:execution"]

  - name: phase-finalization
    condition:
      field: substate
      equals: "finalization"
    tags: ["phase:finalization"]

  - name: phase-readme-wave
    condition:
      field: substate
      equals: "readme-wave"
    tags: ["phase:readme-wave"]

  - name: phase-oracle-regen
    condition:
      field: substate
      equals: "oracle-regen"
    tags: ["phase:oracle-regen"]

  - name: phase-porcelain
    condition:
      field: substate
      equals: "porcelain"
    tags: ["phase:porcelain"]

  - name: phase-archive-upload
    condition:
      field: substate
      equals: "archive-upload"
    tags: ["phase:archive-upload"]

  - name: phase-idle
    condition:
      field: skill
      is_empty: true
    tags: ["phase:idle"]

  # ==========================================================================
  # transition: State machine transition events
  # ==========================================================================

  - name: transition-phase-start
    condition:
      field: state_transition
      equals: "phase_start"
    tags: ["transition:phase-start"]

  - name: transition-phase-end
    condition:
      field: state_transition
      equals: "phase_end"
    tags: ["transition:phase-end"]

  - name: transition-handoff
    condition:
      field: state_transition
      equals: "handoff"
    tags: ["transition:handoff"]

  - name: transition-phase-fail
    condition:
      field: state_transition
      equals: "phase_fail"
    tags: ["transition:phase-fail"]

  - name: transition-epoch-close
    condition:
      field: has_epoch_summary
      equals: true
    tags: ["transition:epoch-close"]

  # ==========================================================================
  # skill: Active skill type
  # ==========================================================================

  - name: skill-task
    condition:
      field: skill
      equals: "task"
    tags: ["skill:task"]

  - name: skill-self-improve
    condition:
      field: skill
      equals: "self-improve"
    tags: ["skill:self-improve"]

  - name: skill-update-and-archive
    condition:
      field: skill
      equals: "update-and-archive"
    tags: ["skill:update-and-archive"]

  - name: skill-log
    condition:
      field: skill
      equals: "log"
    tags: ["skill:log"]

  - name: skill-none
    condition:
      field: skill
      is_empty: true
    tags: ["skill:none"]

  # ==========================================================================
  # trigger: What initiated this archive entry
  # ==========================================================================

  - name: trigger-build
    condition:
      field: trigger
      equals: "build"
    tags: ["trigger:build"]

  - name: trigger-skill
    condition:
      field: trigger
      equals: "skill"
    tags: ["trigger:skill"]

  - name: trigger-manual
    condition:
      field: trigger
      equals: "manual"
    tags: ["trigger:manual"]

  # ==========================================================================
  # scope: Change breadth (file types, repo count)
  # ==========================================================================

  - name: scope-cross-repo
    condition:
      field: repos_changed_count
      greater_than: 2
    tags: ["scope:cross-repo"]

  - name: scope-multi-repo
    condition:
      field: repos_changed_count
      equals: 2
    tags: ["scope:multi-repo"]

  - name: scope-css-js
    condition:
      field: files_modified
      matches_any: ["*.css", "*.js"]
    tags: ["scope:css-js"]

  - name: scope-lean
    condition:
      field: files_modified
      matches_any: ["*.lean"]
    tags: ["scope:lean"]

  - name: scope-python
    condition:
      field: files_modified
      matches_any: ["*.py"]
    tags: ["scope:python"]

  - name: scope-config
    condition:
      field: files_modified
      matches_any: ["*.yaml", "*.json", "*.toml"]
    tags: ["scope:config"]

  - name: scope-wide
    condition:
      field: files_modified_count
      greater_than: 50
    tags: ["scope:wide"]

  - name: scope-narrow
    condition:
      field: files_modified_count
      less_than: 5
    tags: ["scope:narrow"]

  # ==========================================================================
  # repo: Which repositories were touched
  # ==========================================================================

  - name: repo-dress
    condition:
      field: files_modified
      matches_any: ["*/Dress/*"]
    tags: ["repo:dress"]

  - name: repo-runway
    condition:
      field: files_modified
      matches_any: ["*/Runway/*"]
    tags: ["repo:runway"]

  - name: repo-sbs-test
    condition:
      field: files_modified
      matches_any: ["*/SBS-Test/*"]
    tags: ["repo:sbs-test"]

  - name: repo-gcr
    condition:
      field: files_modified
      matches_any: ["*/General_Crystallographic_Restriction/*"]
    tags: ["repo:gcr"]

  - name: repo-pnt
    condition:
      field: files_modified
      matches_any: ["*/PrimeNumberTheoremAnd/*"]
    tags: ["repo:pnt"]

  - name: repo-verso
    condition:
      field: files_modified
      matches_any: ["*/verso/*"]
    tags: ["repo:verso"]

  - name: repo-subverso
    condition:
      field: files_modified
      matches_any: ["*/subverso/*"]
    tags: ["repo:subverso"]

  - name: repo-lean-architect
    condition:
      field: files_modified
      matches_any: ["*/LeanArchitect/*"]
    tags: ["repo:lean-architect"]

  - name: repo-sbs-lsp-mcp
    condition:
      field: files_modified
      matches_any: ["*/sbs-lsp-mcp/*"]
    tags: ["repo:sbs-lsp-mcp"]

  - name: repo-dress-blueprint-action
    condition:
      field: files_modified
      matches_any: ["*/dress-blueprint-action/*"]
    tags: ["repo:dress-blueprint-action"]

  # ==========================================================================
  # linkage: Connections to external artifacts (issues, PRs, plans)
  # ==========================================================================

  - name: linkage-has-issue
    condition:
      field: issue_refs
      is_empty: false
    tags: ["linkage:has-issue"]

  - name: linkage-has-pr
    condition:
      field: pr_refs
      is_empty: false
    tags: ["linkage:has-pr"]

  - name: linkage-has-plan
    condition:
      field: plan_count
      greater_than: 0
    tags: ["linkage:has-plan"]

  # ==========================================================================
  # outcome: Build and gate results
  # ==========================================================================

  - name: outcome-build-success
    condition:
      field: build_success
      equals: true
    tags: ["outcome:build-success"]

  - name: outcome-build-fail
    condition:
      field: build_success
      equals: false
    tags: ["outcome:build-fail"]

  - name: outcome-gate-pass
    condition:
      field: gate_passed
      equals: true
    tags: ["outcome:gate-pass"]

  - name: outcome-gate-fail
    condition:
      field: gate_passed
      equals: false
    tags: ["outcome:gate-fail"]

# =============================================================================
# Python hooks for complex analysis
# Hooks receive (entry: ArchiveEntry, sessions: list[SessionData]) and return list[str]
# =============================================================================
hooks:
  - name: session-profiler
    module: session_profiler
    function: profile_session

  - name: signal-detector
    module: signal_detector
    function: detect_signals

  - name: outcome-tagger
    module: outcome_tagger
    function: tag_outcomes
