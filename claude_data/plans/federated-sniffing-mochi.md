# Issue #359: Environment-Based Declaration Discovery

## Context

Adding SBS to an existing Lean project requires annotating every declaration with `@[blueprint]` and importing Dress in every file. This is a significant adoption barrier. OSreconstruction (large existing project, zero SBS annotations) is the motivating example.

**Goal:** Dress scans the Lean environment for ALL project-local declarations automatically. `@[blueprint]` becomes optional enrichment metadata (description, informal statement/proof, manual status overrides). Manual dependency overrides (`uses`/`proofUses`) are removed entirely — dependencies are 100% inferred from expression trees.

## User Decisions

- AutoTag: **removed** (superseded by environment discovery)
- `uses`/`proofUses`: **removed** from `@[blueprint]` attribute
- Visual distinction for untagged declarations: **none**
- `collectUsed` stop condition: **replaced entirely** (project-local eligible, not blueprintExt)
- Filtering logic: **stays in Dress**, precomputed `NameSet` passed to `collectUsed`
- Scope: **full pipeline**, validated on OSreconstruction

## Wave 1: LeanArchitect (upstream)

### 1a. `Architect/CollectUsed.lean` — New stop condition

Add `eligibleNames : NameSet` to `CollectUsed.Context`. Replace stop condition:

```
-- Current (line 32):
if c != root && (blueprintExt.find? env c).isSome then
-- New:
if c != root && eligibleNames.contains c then
```

Update `collectUsed` signature: add `eligibleNames : NameSet` parameter. Thread it through to `Context`.

### 1b. `Architect/Basic.lean` — Strip `NodePart` dependency fields

Remove from `NodePart`: `uses`, `excludes`, `usesLabels`, `excludesLabels`

Remaining `NodePart`:
```lean
structure NodePart where
  text : String
  latexEnv : String
```

Remove `register_option blueprint.ignoreUnknownConstants` and `tryResolveConst` (only existed for `uses` resolution).

### 1c. `Architect/Attribute.lean` — Strip uses/proofUses from syntax and Config

Remove from `Config`: `uses`, `excludes`, `usesLabels`, `excludesLabels`, `proofUses`, `proofExcludes`, `proofUsesLabels`, `proofExcludesLabels`

Remove syntax: `blueprintSingleUses`, `blueprintUses`, `blueprintUsesOption`, `blueprintProofUsesOption`, `elabBlueprintUses`

Remove match arms in `elabBlueprintConfig` for `uses`/`proofUses`.

Update `mkStatementPart`/`mkProofPart` to not populate removed fields.

### 1d. `Architect/Output.lean` — Simplify `inferUses`

`NodePart.inferUses` becomes a pure label resolution (no manual override merging):
- Accept `resolveLabel : Name → Option String` parameter instead of reading `blueprintExt` directly
- Just convert `collectUsed` output names to labels via the resolver
- Remove exclude logic

`Node.inferUses` accepts `eligibleNames` and `resolveLabel`, passes them through.

### 1e. `Architect/RPC.lean` — Update BlueprintInfo

Remove `dependencies` array exposure that sourced from `uses`/`usesLabels` (lines 87-91). Or replace with auto-inferred dependency display.

## Wave 2: Dress (depends on Wave 1)

### 2a. `Dress/Graph/Build.lean` — Core: expand `fromEnvironment`

**New signature:**
```lean
def fromEnvironment (env : Environment) (projectModules : Array Name) : CoreM Graph
```

**New flow:**
1. Compute `eligibleNames : NameSet` — all project-local eligible constants (reuse `isProjectModule`, `isEligibleConstant`, `isAutoGenerated`, `isProjection` filtering)
2. Also insert all `blueprintExt` names into eligible set
3. Build `resolveLabel` function: tagged → `latexLabel`, untagged → `Name.toString`
4. For tagged declarations: build `NodeBuildData` with enrichment (existing path)
5. For untagged declarations: build minimal `NodeBuildData` (name as label, auto-derived status/kind)
6. Call `collectUsed` with `eligibleNames` for edge inference
7. `buildGraph` with unified node data array

### 2b. Delete `Dress/AutoTag.lean`

445 lines, no longer needed.

### 2c. `Main.lean` — Remove AutoTag CLI, update graph call

- Remove `import Dress.AutoTag`
- Remove `runAutoTagCmd`, `autoTagCmd`, and SUBCOMMANDS entry
- Update `runGraphCmd`: `Graph.fromEnvironment (← getEnv) modules`

### 2d. `Dress/Quickstart.lean` — Update quickstart instructions

Line 431: Replace auto-tag suggestion with note about optional `@[blueprint]` enrichment.

### 2e. `Dress/Output.lean` + `Dress/Generate/Latex.lean` — Update `inferUses` callers

Pass `eligibleNames` and `resolveLabel` to all `inferUses` call sites. LaTeX output stays tagged-only (untagged declarations don't produce LaTeX artifacts).

## Wave 3: Migration + Validation

### 3a. SBS-Test `StatusDemo.lean` — Rewrite declarations

19 `uses := [...]` entries establish artificial graph edges between trivial declarations. After removing `uses`, these become disconnected nodes. **Rewrite the demo declarations to have actual Lean code dependencies** so the graph structure is expression-inferred.

### 3b. SBS-Test `ModuleRefTest.lean` — Remove `uses`

1 occurrence. Remove `(uses := ["mod:first"])`.

### 3c. PNT — Remove `uses`

3 occurrences across 2 files. Remove and verify edges are auto-inferred.

### 3d. OSreconstruction — Add Dress dependency

Add to `lakefile.toml`:
```toml
[[require]]
name = "Dress"
path = "../../toolchain/Dress"
```

No `import Dress` needed in source files — graph is built from environment scan.

### 3e. Validation

1. Build LeanArchitect → Dress → SBS-Test (regression)
2. Run `lake exe extract_blueprint graph SBSTest` — verify graph still works
3. Build OSreconstruction with Dress dependency
4. Run `lake exe extract_blueprint graph OSReconstruction` — verify graph includes all declarations
5. Visual QA on SBS-Test to check graph renders correctly
6. Run `sls_run_tests` for evergreen test suite

## Key Files

| File | Change |
|------|--------|
| `forks/LeanArchitect/Architect/CollectUsed.lean` | eligibleNames stop condition |
| `forks/LeanArchitect/Architect/Basic.lean` | Strip NodePart dependency fields |
| `forks/LeanArchitect/Architect/Attribute.lean` | Strip uses/proofUses syntax + Config |
| `forks/LeanArchitect/Architect/Output.lean` | Simplify inferUses (resolveLabel param) |
| `forks/LeanArchitect/Architect/RPC.lean` | Update dependency display |
| `toolchain/Dress/Dress/Graph/Build.lean` | fromEnvironment expansion (core change) |
| `toolchain/Dress/Dress/AutoTag.lean` | DELETE |
| `toolchain/Dress/Main.lean` | Remove AutoTag CLI, update graph call |
| `toolchain/Dress/Dress/Quickstart.lean` | Update instructions |
| `toolchain/Dress/Dress/Output.lean` | Update inferUses caller |
| `toolchain/Dress/Dress/Generate/Latex.lean` | Update inferUses caller |
| `toolchain/SBS-Test/SBSTest/StatusDemo.lean` | Rewrite for real dependencies |
| `showcase/OSreconstruction/lakefile.toml` | Add Dress dependency |

## Risks

- **StatusDemo rewrite**: The demo's artificial graph structure needs real Lean dependencies. This is the most creative part of the task.
- **Large graph scale**: OSreconstruction may produce hundreds of nodes. SVG layout handles this (transitive reduction skips at >500 nodes).
- **collectUsed performance**: Actually improves — more stop points = shorter traversal.
- **Lean version compatibility**: OSreconstruction may be on a different Lean/mathlib version than Dress. May need version alignment.
