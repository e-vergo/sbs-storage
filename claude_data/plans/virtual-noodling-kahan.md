# Crush Issues #351, #352, #353

## Context

Three issues filed today during a prior session's planning phase. After code review, the situation is:

- **#351 (Dashboard link targets)**: Already resolved in the current codebase. Key declarations, messages, and project notes already use `"dep_graph.html" ++ node.url`. Kernel Verification and Blueprint Coverage already have no href. Only Connectedness and Cycles have `href := some "dep_graph.html"` which the issue says to keep. **Action: close with evidence.**
- **#352 (Modal overlay links)**: Already fixed by a prior agent in this session. `verso-code.js` has `e.preventDefault()`, URL fixup in `onModalOpen`, and dead code removed. **Action: verify during build/QA, then close.**
- **#353 (FAQ redesign)**: The only actual implementation work. Substantial rewrite of FAQ page generation.

## Wave 1: #353 Implementation

### Agent A: FAQ Lean Code (`Faq.lean` + `Theme.lean`)

**File: `Runway/Runway/Faq.lean`** — major rewrite

1. Add `id : String` field to `FaqEntry` structure (URL-safe slug)
2. Add `slugify` helper: lowercase, replace spaces/special chars with hyphens (similar to `sanitizeNodeId` in `DepGraph.lean` but broader)
3. Update `collectToolchainDocs` and `collectUserDocs` to populate `id` field using `slugify s!"{category}-{title}"`
4. Rewrite `renderCategory` and `renderSection` into `faqIndexContent`:
   - Category-grouped `<details>` with `dg-chapter-group`/`dg-chapter-summary` CSS classes
   - Entry table inside each group with links to `faq/{entry.id}.html`
   - Preview column showing first line of content
5. Add `faqEntryPage` function:
   - Uses `DepGraph.breadcrumb` with items: `[("FAQ", some "../faq.html"), (entry.category, none), (entry.title, none)]`
   - Content in `<div class="faq-content" data-markdown>` (not `<pre>`)
   - Prev/next navigation within category
   - Uses `pageShell` with `toRoot = "../"` and `bodyClass = "faq-entry-page"`
6. Rewrite `generateFaqPage` to accept two sidebars (`indexSidebar` and `entrySidebar`):
   - Generate `faq.html` (index page) with `indexSidebar`
   - Create `faq/` subdirectory
   - Generate `faq/{id}.html` for each entry with `entrySidebar`

**File: `Runway/Runway/Theme.lean`** — two call sites (lines 584-585 and 805-806)

7. At each call site, add entry sidebar generation:
   ```lean
   let faqSidebar := DefaultTheme.renderSidebar site.chapters (some "faq") "" site.config availDocs
   let faqEntrySidebar := DefaultTheme.renderSidebar site.chapters (some "faq") "../" site.config availDocs
   Faq.generateFaqPage site outputDir faqSidebar faqEntrySidebar
   ```

### Agent B: FAQ CSS + JS (`faq.css` + `verso-code.js`)

**File: `dress-blueprint-action/assets/faq.css`** — complete rewrite

8. Remove all existing details/summary/pre styling
9. Add styles for:
   - `.faq-container` layout (padding, headings)
   - Reuse `dg-chapter-group`/`dg-chapter-summary`/`dg-declaration-table` patterns directly (classes generated by Lean code match dep graph)
   - `.faq-entry-page .content` layout (flex, padding, overflow)
   - `.faq-rendered-content` markdown styles (h1-h6, code, pre, blockquote, lists, tables)
   - `.faq-entry-nav` prev/next layout (flex, border-top, spacing)
   - Dark mode via `[data-theme="dark"]` using `--sbs-*` / `--bp-*` variables

**File: `dress-blueprint-action/assets/verso-code.js`** — small addition

10. Add FAQ markdown rendering inside the existing `DOMContentLoaded` block (after MathJax/Tippy init):
    ```javascript
    if (typeof marked !== 'undefined') {
        document.querySelectorAll('.faq-content[data-markdown]').forEach(function(el) {
            el.innerHTML = marked.parse(el.textContent);
            el.removeAttribute('data-markdown');
        });
    }
    ```

### File Collision Matrix

| File | Agent A | Agent B |
|------|---------|---------|
| `Runway/Faq.lean` | WRITE | — |
| `Runway/Theme.lean` | WRITE | — |
| `faq.css` | — | WRITE |
| `verso-code.js` | — | WRITE |

No overlaps. Agents run in parallel.

## Wave 2: Build + QA

11. Build SBS-Test: `./dev/build-sbs-test.sh`
12. Check `lean_diagnostic_messages` on `Faq.lean` and `Theme.lean`
13. Verify FAQ pages render correctly (index + individual entries)
14. Run `sls_converge` or `sls_qa` against SBS-Test
15. Fix any issues, rebuild, re-verify

## Wave 3: Close Issues

16. Close #351 with comment: "Already resolved — code matches desired state"
17. Close #352 with commit reference to verso-code.js changes
18. Close #353 with commit reference

## Risks

- **Sidebar `toRoot` mismatch**: If entry sidebar uses wrong `toRoot`, all links break on `faq/*.html` pages. Mitigated by following exact dep graph pattern (line 545 in Theme.lean).
- **Marked.js timing**: Must load before `verso-code.js` runs. Already guaranteed by `pageShell` loading marked in `<head>` and verso-code.js at bottom of `<body>`.
- **Empty FAQ entries**: If no README.md files exist (clean checkout), index should show empty state gracefully. Current `collectToolchainDocs` handles this.
- **Slugify collisions**: Two entries could produce the same slug. Low risk given the input domain (repo names + section titles), but could add a dedup suffix if needed.

## Verification

1. `lean_diagnostic_messages` clean on modified Lean files
2. SBS-Test builds successfully
3. `faq.html` renders with category-grouped tables
4. `faq/{id}.html` pages render with breadcrumb, markdown content, prev/next
5. Breadcrumb links navigate correctly
6. Dark mode works on FAQ pages
7. Modal links work on dep graph pages (verifies #352)
8. Dashboard links correct (verifies #351 already-resolved state)
