# Plan: Auto-Tag Tool + OSforGFF 100% Coverage + Enrichment

## Context

Issue #332: OSforGFF has 87.75% `@[blueprint]` coverage (752/857 eligible declarations). 105 declarations across 22 modules are uncovered. The user wants to:
1. Build a reusable auto-tagging CLI tool in Dress
2. Apply it to reach 100% coverage
3. Enrich declarations across the entire repo with statement/title/status/metadata
4. Document the tool in the quickstart guide and rebuild

## Workstream 1: Auto-Tag CLI (`Dress/AutoTag.lean` + `Main.lean`)

### Architecture

New `auto-tag` subcommand added to the existing `extract_blueprint` CLI. Reuses existing infrastructure:

- `computeCoverage` (`Dress/Graph/Build.lean:475`) — discovers uncovered declarations
- `isEligibleConstant`, `isAutoGenerated`, `isProjection`, `constantKind` (same file)
- `runEnvOfImports` (`Dress/Load.lean:25`) — loads Lean environment
- `findDeclarationRanges?` (Lean core) — source positions
- `getSrcSearchPath >>= findWithExt "lean" module` — file path resolution

### Algorithm

1. Load environment via `runEnvOfImports` with all project modules
2. Call `computeCoverage` to get `Array UncoveredDecl`
3. For each uncovered declaration:
   a. Look up `findDeclarationRanges?` for source position
   b. Resolve file path via `getSrcSearchPath >>= findWithExt`
   c. Determine kind via `constantKind`
   d. Compute insertion: theorems/lemmas get `@[blueprint (statement := /-- -/) (proof := /-- -/)]`, everything else gets bare `@[blueprint]`
4. Group insertions by file
5. For each file, read lines, insert bottom-up (preserving line numbers), write back

#### Insertion point logic

- `DeclarationRanges.range.pos.line` = start of full declaration (incl. doc comments + attributes)
- Walk forward from `range.pos.line` to find the declaration keyword line (`theorem`/`def`/`lemma`/`structure`/`class`/`instance`/`abbrev`/`inductive`/`opaque`/`axiom`, handling `noncomputable`/`private`/`protected`/`unsafe` prefixes)
- If `@[...]` attributes exist between doc comment and keyword, insert before the first attribute line
- If no attributes, insert immediately before the keyword line
- Match indentation of the keyword line

### Files to create/modify

| File | Action |
|------|--------|
| `toolchain/Dress/Dress/AutoTag.lean` | **NEW** — Core auto-tag logic (`TagInsertion`, `resolveInsertion`, `applyInsertions`, `runAutoTag`) |
| `toolchain/Dress/Main.lean` | **MODIFY** — Add `runAutoTagCmd`, `autoTagCmd` CLI definition, register in `blueprintCmd` SUBCOMMANDS |

`Dress.lean` stays unchanged — AutoTag is CLI-only, imported directly by Main.lean as `import Dress.AutoTag`.

### CLI interface

```bash
lake exe extract_blueprint auto-tag OSforGFF          # apply tags
lake exe extract_blueprint auto-tag --dry-run OSforGFF  # preview only
```

## Workstream 2: OSforGFF Coverage + Enrichment

### Phase A: Auto-tag to 100%

Run the tool against OSforGFF. Verify with `computeCoverage` reporting 100%.

### Phase B: Manual enrichment (all 46 files)

Enrichment tiers:

**Tier 1 — Full enrichment** (~10 files, key results):
`OS_Axioms.lean`, `GFFmaster.lean`, `Basic.lean`, `GaussianFreeField.lean`, `GFFMconstruct.lean`, `GFFIsGaussian.lean`, `OS0_GFF.lean`–`OS4_Clustering.lean`, `OS4_Ergodicity.lean`
- `statement` with LaTeX, `title`, `keyDeclaration`, `status`, `uses`

**Tier 2 — Statement enrichment** (~15 files, supporting theorems):
`Minlos*.lean`, `Covariance*.lean`, `Euclidean.lean`, `DiscreteSymmetry.lean`, `Schwinger*.lean`, `OS3_*.lean`, `FrobeniusPositivity.lean`, `PositiveDefinite.lean`
- `title`, `statement` for named theorems, `status`

**Tier 3 — Light enrichment** (~21 files, utilities):
Remaining files — `title` where meaningful, `status` flags

### Wave structure (4 concurrent agents, non-overlapping files)

- **Agent A**: Tier 1 core OS axiom files (~10 files)
- **Agent B**: Tier 1 construction + Tier 2 covariance (~12 files)
- **Agent C**: Tier 2 symmetry + OS3 (~10 files)
- **Agent D**: Tier 3 infrastructure (~14 files)

## Workstream 3: Blueprint TeX Enhancement

After enrichment, update `blueprint/src/blueprint.tex` (735 lines, 11 chapters + appendix) to reflect the expanded coverage. All 46 modules already have `\inputleanmodule{}` directives, so newly tagged declarations appear automatically in generated content. The enhancement is to the **narrative text**:

- Update section descriptions to reference newly annotated declarations (especially where important theorems/defs were previously uncovered and thus invisible in the blueprint)
- Add itemized references to key newly-tagged declarations in chapters where they belong
- Ensure the expository flow integrates well with the richer generated content from enriched `statement`/`title` fields
- Add any missing cross-references between sections now that the full dependency graph is visible

This is a writing task — 1-2 agents reviewing the enriched Lean files against the existing TeX narrative and updating accordingly.

### File to modify

| File | Action |
|------|--------|
| `showcase/OSforGFF/blueprint/src/blueprint.tex` | **MODIFY** — Update narrative text to match enriched declarations |

## Workstream 4: Documentation + Rebuild

1. Update `Side-By-Side-Blueprint/README.md` quickstart — add auto-tag step between "Add Dress dependency" and "Annotate declarations"
2. Rebuild OSforGFF: `lake build && lake build +:blueprint && lake build +:depGraph`

## Execution Order

```
Wave 0: Build auto-tag tool in Dress (1 agent, sequential)
  └─ Create AutoTag.lean, modify Main.lean
  └─ lake build in Dress to verify
Wave 1: Apply auto-tag to OSforGFF (1 agent, sequential)
  └─ Run tool, verify 100% coverage
  └─ Commit coverage milestone
Wave 2: Manual enrichment (4 agents, parallel)
  └─ Agents A-D on non-overlapping file sets (Lean files only)
Wave 3: Blueprint TeX enhancement (1-2 agents, sequential after Wave 2)
  └─ Update blueprint.tex narrative to match enriched declarations
Wave 4: Docs + rebuild (1-2 agents)
  └─ README update + full blueprint rebuild + verify
```

## Verification

1. **Wave 0**: `lake build` in Dress succeeds. `--dry-run` against OSforGFF shows ~105 insertions.
2. **Wave 1**: `computeCoverage` reports 100%. `lake build` in OSforGFF succeeds.
3. **Wave 2**: `lake build` succeeds. Key declarations have `statement`, `title`, `keyDeclaration`.
4. **Wave 3**: `blueprint.tex` narrative references newly enriched declarations. No orphaned or stale references.
5. **Wave 4**: Full rebuild produces valid dep-graph.json + manifest.json. README has auto-tag docs. Dashboard shows green coverage checkmark.

## Key risks

- **Position resolution**: `findDeclarationRanges?` may return `none` for some declarations. Mitigation: log warnings and skip, report count.
- **Doc comment vs attribute ordering**: Need careful line walking to insert after doc comments but before keywords. Mitigation: conservative algorithm, `--dry-run` for preview.
- **Enrichment quality**: LaTeX statement text requires mathematical understanding. Mitigation: agents read existing doc comments (extensive in OSforGFF) as source material.
